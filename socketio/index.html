<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Socket.IO chat</title>
    <link rel="stylesheet" href="/main.css" />
</head>
<body>



<div class="chat-container">
    <div class="chat-messages" id="chat-messages">
        <div class="message received">–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?</div>
    </div>
    <button id="recorder" class="voice-button">
        <svg
                width="63"
                height="63"
                viewBox="0 0 63 63"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
        >
            <g id="microphone/animation" clip-path="url(#clip0_1_2212)">
                <path
                        id="Vector"
                        d="M44.625 28.875C44.625 36.12 38.745 42 31.5 42C24.255 42 18.375 36.12 18.375 28.875H13.125C13.125 38.1412 19.9762 45.7537 28.875 47.04V55.125H34.125V47.04C43.0238 45.7537 49.875 38.1412 49.875 28.875H44.625Z"
                        fill="white"
                />
                <path
                        id="Vector_2"
                        d="M31.5 36.75C35.8575 36.75 39.375 33.2325 39.375 28.875V13.125C39.375 8.7675 35.8575 5.25 31.5 5.25C27.1425 5.25 23.625 8.7675 23.625 13.125V28.875C23.625 33.2325 27.1425 36.75 31.5 36.75ZM28.875 13.125C28.875 11.6813 30.0563 10.5 31.5 10.5C32.9438 10.5 34.125 11.6813 34.125 13.125V28.875C34.125 30.3188 32.9438 31.5 31.5 31.5C30.0563 31.5 28.875 30.3188 28.875 28.875V13.125Z"
                        fill="white"
                />
                <path
                        id="Vector_3"
                        d="M31.5 36.75C35.8575 36.75 39.375 33.2325 39.375 28.875V15.75H31.5H23.625V28.875C23.625 33.2325 27.1425 36.75 31.5 36.75Z"
                        fill="white"
                />
            </g>
            <defs>
                <clipPath id="clip0_1_2212">
                    <rect width="63" height="63" fill="white" />
                </clipPath>
            </defs>
        </svg>
    </button>
    <div class="user-input">
        <form id="form" action="">
            <input type="text" id="text-input" />

            <button id="send-button">
                <svg
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                >
                    <g id="Frame">
                        <path
                                id="Vector"
                                d="M18.3333 1.66663L9.16663 10.8333"
                                stroke="white"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                        />
                        <path
                                id="Vector_2"
                                d="M18.3333 1.66663L12.5 18.3333L9.16663 10.8333L1.66663 7.49996L18.3333 1.66663Z"
                                stroke="white"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                        />
                    </g>
                </svg>
            </button>
        </form>

    </div>

</div>



<audio id="audio" style="display: none;" controls>
    <source src="" >
</audio>

<script src="/plugin.js"></script>

<script src="/socket.io/socket.io.js"></script>

<script>
    const socket = io();

    const messages = document.getElementById('messages');
    const form = document.getElementById('form');
    const input = document.getElementById('text-input');

    const textInput = document.getElementById("text-input");
    const sendButton = document.getElementById("send-button");
    const chatMessages = document.getElementById("chat-messages");

    const addUserMessage = (msg) => {
        const userMessage = msg;

        const userMessageDiv = document.createElement("div");
        userMessageDiv.classList.add("message", "sent");
        userMessageDiv.innerHTML = `<div class="message-icon">üë§</div>${userMessage}`;

        chatMessages.appendChild(userMessageDiv);

        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    const addGptMessage = (msg) => {
            // –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (–∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç):
            const chatbotResponse = msg;

            const chatbotMessageDiv = document.createElement("div");
            chatbotMessageDiv.classList.add("message", "received");
            chatbotMessageDiv.innerHTML = `<div class="message-icon">ü§ñ</div>${chatbotResponse}`;

            chatMessages.appendChild(chatbotMessageDiv);

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–∏–∑
            chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    var srcElement = document.getElementById("audio");

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (input.value) {

            addUserMessage(input.value);


            let python = fetch('/text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({texts: [input.value]})
            }).then(resPython => {
                resPython.json().then(text => {

                    addGptMessage(text.resp);
                    // socket.emit('chat message', text.resp);

                    let respVoice = fetch('/api/tts?voice='+encodeURIComponent('ru_RU/multi_low#hajdurova')+'&noiseScale=0.667&noiseW=0.8&lengthScale=1&ssml=false&audioTarget=client&text='+encodeURIComponent(text.resp) ).then((res) => {
                        res.blob().then(res => {
                            srcElement.src = URL.createObjectURL(res);
                            srcElement.play();
                        });
                    });
                });

            });

            input.value = '';
        }
    });






    let command = new SAWDVoiceCommand(
        {
            // parent_html_element: document.querySelector('body'),
            button_html_element: document.getElementById('recorder'),
            callbacks: {
                recognized: (str) => {
                    console.log('recognized', str);
                    // socket.emit('chat message', str);
                    addUserMessage(str);
                },
                tts: (blob, str) => {
                    // socket.emit('chat message', str);

                    addGptMessage(str);
                    srcElement.src = URL.createObjectURL(blob);
                    srcElement.play();
                }
            }
        }
    );




    // sendButton.addEventListener("click", () => {
    //     const userMessage = textInput.value;
    //     textInput.value = "";
    //
    //     const userMessageDiv = document.createElement("div");
    //     userMessageDiv.classList.add("message", "sent");
    //     userMessageDiv.innerHTML = `<div class="message-icon">üë§</div>${userMessage}`;
    //
    //     chatMessages.appendChild(userMessageDiv);
    //
    //     // –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (–∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç):
    //     const chatbotResponse = "–≠—Ç–æ –æ—Ç–≤–µ—Ç –æ—Ç ChatGPT.";
    //
    //     const chatbotMessageDiv = document.createElement("div");
    //     chatbotMessageDiv.classList.add("message", "received");
    //     chatbotMessageDiv.innerHTML = `<div class="message-icon">ü§ñ</div>${chatbotResponse}`;
    //
    //     chatMessages.appendChild(chatbotMessageDiv);
    //
    //     // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–∏–∑
    //     chatMessages.scrollTop = chatMessages.scrollHeight;
    // });

</script>
</body>
</html>